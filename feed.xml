<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" ><generator uri="https://jekyllrb.com/" version="3.9.3">Jekyll</generator><link href="/feed.xml" rel="self" type="application/atom+xml" /><link href="/" rel="alternate" type="text/html" /><updated>2024-04-14T14:24:42+02:00</updated><id>/feed.xml</id><title type="html">Özgün ÖZ</title><subtitle>Fullstack Developer, Msc. Computer Engineer</subtitle><entry><title type="html">How to handle Secrets in Java</title><link href="/secrets_in_java" rel="alternate" type="text/html" title="How to handle Secrets in Java" /><published>2023-08-30T12:18:00+02:00</published><updated>2023-08-30T12:18:00+02:00</updated><id>/secrets_in_java</id><content type="html" xml:base="/secrets_in_java"><![CDATA[<p>This post gives an overview of the different ways to manage configuration parameters for software applications in general, and focuses on the management of secrets with environment variables for applications written in java.</p>

<p>All modern production applications have some parameters/configurations to allow maximum flexibility of its execution. 
There are different ways to manage those parameters, as there are different type of parameters, 
as there are different type of processes/applications that can run as on a Server. 
We will cover all those type of parameters, for the scope of a java application, in detail further below this post. 
The catch here is that the parameters of an application is usually managed separately than the code that will be packaged as the executable.<br />
A good reading about the why’s and how’s is the post from <strong><a href="https://12factor.net/config">12 factor app</a></strong></p>

<p>Many applications today manages some configuration/parameters that needs to be kept secret, aka <em>secrets</em>. 
Sometimes it is the credentials to access a DB, some other times it is the key to encrypt a communication with another application. 
Different from other parameter/config, these values must be stored and managed by the application carefully in order to prevent their leak.</p>

<p>First lets see the different ways to pass application parameters in a java, then we will focus on the best practices to do so for secrets specifically.</p>

<h1> Arguments ? Properties ? Variables ? </h1>
<p>As a junior, or even an experienced developer you may sometimes confuse one for the other if you never had to deal with the subtle differences.
We will cover all those in details, and have a resumé of differences at the end.</p>

<h3>1. Program Arguments</h3>
<p>Program arguments in java are the parameters you provide when running your java application. They are also called command-line arguments. Here is how you can use it:</p>

<p>Lets say you have a main class like so;</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Echo</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span> <span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="nc">String</span> <span class="nl">s:</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">s</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre></figure>

<p>Now, when you package your application as a jar, and you run it, you can pass arguments like so:</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">java <span class="nt">-jar</span> MyApplication.jar paramStr1 paramStr2</code></pre></figure>

<p>The arguments you pass after the jar file will be given to your main method as String parameters. <br />
If you want to change the type of the argument, you need to parse or cast the String object.<br />
Since we are talking about running our application in command line, only String parameters makes sense in that context.</p>

<h3>2. JVM arguments</h3>
<p>When we execute a java program from the command line, using the <code>java</code> executable from the JRE lib, we can pass multiple <em>Options</em> to the JVM. <br />
The <code>java -jar</code> option is only one of them.</p>

<p>It is easy to confuse them with Program arguments, since they are also sometimes called <em>JVM arguments</em>.
Different from Program args, JVM args are passed to the JVM directly and are meant to modify its behaviour. The most known usage is to set the maximum Heap size <code>-Xmx</code> flag.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">java <span class="nt">-jar</span> <span class="nt">-Xmx</span><span class="o">=</span>2g MyApplication.jar paramStr1 paramStr2</code></pre></figure>

<p>A full list of options for the Hotspot JVM is available <a href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html">here</a> along the standard options that are general to all JVMs.</p>

<h3>3. System Properties</h3>
<p>A specific type of JVM argument allows you to set the properties of the JVM, called <a href="https://docs.oracle.com/javase/tutorial/essential/environment/sysprop.html">System Properties</a>. 
Note that <code>-DsystemProperty1=myStrPropValue</code> below is a JVM argument given with the <code>-D</code> flag.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">java <span class="nt">-jar</span> <span class="nt">-DmySystemProperty</span><span class="o">=</span>mySysPropValue MyApplication.jar paramStr1 paramStr2</code></pre></figure>

<p>Those properties are available from all applications and sub-processes running in the JVM execution. Some predefined properties gives info about the current execution context of your JVM. They can be used in a Java application like so:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">var</span> <span class="n">sysProps</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getProperty</span><span class="o">();</span>
<span class="kt">var</span> <span class="n">pathSeperator</span> <span class="o">=</span> <span class="n">sysProps</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"path.separator"</span><span class="o">);</span>
<span class="n">sysProps</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s">"myCustomProperty"</span><span class="o">,</span> <span class="err">"</span><span class="n">myPropertyValue</span><span class="o">);</span></code></pre></figure>

<p>Beware that setting new Properties or overriding an existing one will be persistent only during the current execution of the JVM and will be deleted once JVM shuts down.
System Properties, like all <a href="https://docs.oracle.com/en/java/javase/17/docs/api/index.html">Properties</a> objects are mere objects available in the Heap and their value is not persisted anywhere on the disk.</p>

<h3>4. Environment Variables</h3>
<p>Environment variables are nothing specific to Java. They are actually set outside the context of our JVM execution. 
They are variables defined on the OS level and are available to all processes (unless we define availability constraints on them).
They are available in all Linux based systems and Windows (with subtle differences). You can this <a href="https://en.wikipedia.org/wiki/Environment_variable">wiki page</a> or this <a href="https://www.twilio.com/blog/how-to-set-environment-variables.html">blog post</a> how to set them.</p>

<p>We can access and use them in java applications like so:</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="kt">var</span> <span class="n">envVars</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">();</span>
<span class="kt">var</span> <span class="n">shell</span> <span class="o">=</span> <span class="n">envVars</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"SHELL"</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"The current Shell type is: "</span> <span class="o">+</span> <span class="n">shell</span><span class="o">);</span>
<span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"The current Operating System is: "</span> <span class="o">+</span> <span class="nc">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">"OS"</span><span class="o">));</span></code></pre></figure>

<p><em>Keep in mind that different platforms operate in different ways. E.g., on UNIX, Linux, and macOS, environment variables are case-sensitive, whereas on Microsoft Windows they are not.</em></p>

<p><em>In a java application, we can use environment variables available to our JVM process. But Java does not have a standard way to modify its environment. This is a decision taken to make the language and application portable. and its design isolated from its execution environment.</em></p>

<h3>5. Properties specific to Frameworks</h3>
<p>If you are using spring or maven, you probably heard about things like (respectively) application properties or project properties.</p>

<h6>Spring application properties</h6>
<p>The best description comes from the official <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config">docs</a>:</p>
<blockquote>
<p>Spring Boot lets you externalize your configuration so that you can work with the same application code in different environments. You can use a variety of external configuration sources including Java properties files, YAML files, environment variables, and command-line arguments.</p>
<p>Property values can be injected directly into your beans by using the @Value annotation, accessed through Spring’s Environment abstraction, or be bound to structured objects through @ConfigurationProperties.</p>
</blockquote>

<p>As described above the @Value/@ConfigurationProperties annotations allow you to use these application parameters in your code. The most commonly used way of defining those parameters is an application.properties/.yaml file. But it is not the only way. Spring have multiple ways/places to define those properties and with an order of priority to allow overriding one defined in another. You can find the detailed list of hierarchy in the official documentation.  <br />
One of them that you should not confuse with System properties, are spring program arguments. You can add application properties them from cli like so <code class="language-plaintext highlighter-rouge">java -jar mySpringApp.jar --someProperty=someValue</code> (see <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config.command-line-args">here</a> for more details).</p>

<p>The already explained configuration parameters like JVM arguments, system properties and environment variables can be sourced to define the spring application properties and used via the respective annotations.</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Value</span><span class="o">(</span><span class="s">"#{systemEnvironment['MY_SECRET']}"</span><span class="o">)</span> <span class="c1">// via environment variables</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="n">s1</span><span class="o">;</span>

<span class="nd">@Value</span><span class="o">(</span><span class="s">"#{systemProperties['myApp.mySystemProperty']}"</span><span class="o">)</span> <span class="c1">// via System properties passed in cli:  java -jar -DmyApp.mySystemProperty=someVal mySpringApp.jar </span>
<span class="kd">private</span> <span class="nc">String</span> <span class="n">s2</span>

<span class="nd">@Value</span><span class="o">(</span><span class="s">"${myApp.myAppProperty:aDefaultValue}"</span><span class="o">)</span> <span class="c1">// via application.property file or other PropertySource definition</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="n">s3</span><span class="o">;</span></code></pre></figure>

<p>if you are using spring boot, you can directly use the following syntax to access env variables and system properties</p>

<figure class="highlight"><pre><code class="language-java" data-lang="java"><span class="nd">@Value</span><span class="o">(</span><span class="s">"${MY_SECRET:aDefaultValue}"</span><span class="o">)</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="n">s1</span><span class="o">;</span>
<span class="nd">@Value</span><span class="o">(</span><span class="s">"${myJVM.mySystemProperty:aDefaultValue}"</span><span class="o">)</span>
<span class="kd">private</span> <span class="nc">String</span> <span class="n">s2</span><span class="o">;</span></code></pre></figure>

<p>Or a cleaner and simpler way, just define them in the same place as other application properties, like in your application.properties/.yaml file
Then access those properties via the @Value annotation with a simpler expression.</p>

<figure class="highlight"><pre><code class="language-shell" data-lang="shell">myApp.mySecretIndirect<span class="o">=</span><span class="k">${</span><span class="nv">MY_SECRET</span>:aDefaultValue<span class="k">}</span>
myApp.mySysPropIndirect<span class="o">=</span><span class="k">${</span><span class="nv">myJVM</span><span class="p">.myProperty</span>:aDefaultValue<span class="k">}</span>
myApp.myAppProperty<span class="o">=</span>SomeValue</code></pre></figure>

<h6>Maven properties</h6>
<p>Again from the official <a href="https://maven.apache.org/pom.html#properties">docs</a>:</p>
<blockquote>
<p>Maven properties are value placeholders, like properties in Ant. Their values are accessible anywhere within a POM by using the notation ${X}, where X is the property. Or they can be used by plugins as default values</p>
</blockquote>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;project&gt;</span>
  ...
  <span class="nt">&lt;properties&gt;</span>
    <span class="nt">&lt;maven.compiler.source&gt;</span>1.7<span class="nt">&lt;/maven.compiler.source&gt;</span>
    <span class="nt">&lt;maven.compiler.target&gt;</span>1.7<span class="nt">&lt;/maven.compiler.target&gt;</span>
    <span class="c">&lt;!-- Following project.-properties are reserved for Maven in will become elements in a future POM definition. --&gt;</span>
    <span class="c">&lt;!-- Don't start your own properties properties with project. --&gt;</span>
    <span class="nt">&lt;project.build.sourceEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.build.sourceEncoding&gt;</span> 
    <span class="nt">&lt;project.reporting.outputEncoding&gt;</span>UTF-8<span class="nt">&lt;/project.reporting.outputEncoding&gt;</span>
  <span class="nt">&lt;/properties&gt;</span>
  ...
<span class="nt">&lt;/project&gt;</span></code></pre></figure>

<p>And again like the above spring properties, maven properties can as well be sourced from the basic java configuration parameters like JVM arguments, system properties and environment variables.<br />
Once defined (like already explained above), you can use them with the below syntax.</p>

<figure class="highlight"><pre><code class="language-xml" data-lang="xml"><span class="nt">&lt;properties&gt;</span>
    <span class="c">&lt;!-- environment variable --&gt;</span>
    <span class="nt">&lt;myApp.githubPAT&gt;</span>${env.MY_GITHUB_PAT}<span class="nt">&lt;/myApp.githubPAT&gt;</span>
    <span class="c">&lt;!-- JVM system properties --&gt;</span>
    <span class="nt">&lt;myApp.javaPath&gt;</span>${java.home}<span class="nt">&lt;/myApp.javaPath&gt;</span>
    <span class="nt">&lt;myApp.OS&gt;</span>${os.name}<span class="nt">&lt;/myApp.OS&gt;</span>
    <span class="c">&lt;!-- JVM System properties , you can give custom ones on cli "mvn -DmyApp.logging.path=... clean install" and access them in pom like normal properties --&gt;</span>
    <span class="nt">&lt;myApp.logging.file&gt;</span>${myApp.logging.path}/myApp.log<span class="nt">&lt;/myApp.logging.file&gt;</span>
    <span class="c">&lt;!-- maven predefined properties --&gt;</span>
    <span class="nt">&lt;myApp.execId&gt;</span>myApp-${maven.build.timestamp}<span class="nt">&lt;/myApp.execId&gt;</span>
    <span class="nt">&lt;jacoco.unit.file&gt;</span>${project.build.directory}/jacoco-unit.exec<span class="nt">&lt;/jacoco.unit.file&gt;</span>
    <span class="c">&lt;!-- user defined property --&gt;</span>
    <span class="nt">&lt;version.jacoco&gt;</span>0.8.7<span class="nt">&lt;/version.jacoco&gt;</span>
    <span class="nt">&lt;version.jacoco.plugin&gt;</span>${version.jacoco}<span class="nt">&lt;/version.jacoco.plugin&gt;</span>
<span class="nt">&lt;/properties&gt;</span></code></pre></figure>

<p>If you are interested in going more into the details of maven, the blog post <a href="./maven_sisu">here</a> is a good article to start with.</p>

<h3>6. Resumé </h3>
<p>If we take those words and analyse the literal meanings outside the scope of programming, we already have a hint of their differences.<br />
<a href="https://en.wikipedia.org/wiki/Command-line_interface#Arguments">Arguments</a> ?  Short for “arguments of a command line expression”. <br />
<a href="https://www.oxfordlearnersdictionaries.com/definition/american_english/property#:~:text=1%5Buncountable%5D%20a%20thing%20or,intellectual%20property%2C%20public%20property%20Thesaurus">Properties</a> ? They are values that defines something.<br />
<a href="https://www.oxfordlearnersdictionaries.com/definition/english/variable_1?q=variable">Variables</a> ? Something that can change outside our will.</p>

<ol>
<li>Program Arguments: String Parameters we pass to our main method. Must be given set startup.</li> 
<li>JVM Arguments: Options that affect how the JVM operates. Must be given set startup.</li> 
<li>System Properties: Value/Keys available in every application running in the JVM. Can be set via command line, or by the code of the java application.</li>
<li>Environment Variables: Values that are set outside the execution of the JVM and cannot be changed by the JVM.</li>
</ol>

<p><img src="../assets/images/JavaPropsVarsArgs.png" /></p>

<h1> Secrets ?</h1>
<p>Now lets get back to the focus element of this post. The credentials in our configuration, aka. secrets.</p>

<p>There are different methods to give secret values as parameters to an application.
The most basic and old way, is to have the credentials stored in a configuration file, located only on a server we consider secure, and we limit all access to it. Like the production server.
For applications that run on bare metal or VMs, this is most often the chosen method.</p>

<p>Just to give a glimpse of some best practices used today without diving into too much details since it is not the subject of this blog post,
if you are using deployment tools like ansible, you can profit from features like <a href="https://docs.ansible.com/ansible/latest/vault_guide">Ansible Vault</a>.</p>

<p><img src="../assets/images/hashicorp_ansible_jenkins_vm.png" /></p>

<p>It allows you to encrypt them with a key so your secret file that is encrypted may even be pushed on version control.
It will then decrypt them on the fly during deployment.
So only the decryption key is needed to be managed during the deployment and execution of the application.
The encryption key is the real secret here and can be stored in your CI tool that will launch the deployments, or you can use a secret manager like <a href="https://www.vaultproject.io/">Hashicorp Vault</a> to keep your secrets.
Most CI tools, like jenkins have <a href="https://plugins.jenkins.io/hashicorp-vault-plugin/">plugins</a>, allowing to communicate with HashiCorp Vault to fetch your secrets during your pipeline execution instead of storing them on the CI server.</p>

<div class="alert">
    <div style="margin-left: 0.7em;">
        <!--<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </svg>--> 
        Warning:
        <em>The most secure way to manage secrets is to not persist them at all anywhere apart we consider secure.
        Also, duplicating the places where you persist the secret widens the attack surface and increase the risk of leak of the secret.</em>
    </div>
</div>

<h3> Secrets accessible to the JVM from Environment Variables </h3>
<p>Application execution environments are considered as not secure since it is a place we do regular changes. Lots of ins and outs, difficult to track and secure.
This is why key management applications, like HashiCorp Vault has come into being. Their only purpose is to store your secrets.</p>

<p>Execution environments like containers have the advantage of being ephemeral which in turns makes the fact of having the secrets accessible on the execution environment more secure. 
Making them accessible via environment variables, instead of a config file persisted on the FS, is considered relatively more secure. 
There are still some concerns about this approach in general ( <a href="https://www.cloudtruth.com/blog/the-pitfalls-of-using-environment-variables-for-config-and-secrets">one</a> or <a href="https://www.trendmicro.com/en_za/research/22/h/analyzing-hidden-danger-of-environment-variables-for-keeping-secrets.html">two</a> among other tones of discussion on platforms like stackexchange and stackoverflow, of blog posts are available on the net)
but most known Container Execution Environment Providers like Docker and Kubernetes has components (<a href="https://kubernetes.io/docs/concepts/configuration/secret/">etcd</a> for K8s) that are considered relatively secure to store the secrets for you.
Kubernetes has even a HashiCorp Vault <a href="https://www.vaultproject.io/use-cases/kubernetes">plugin</a> that allows fetching the secrets from Vault and injecting into the pods, instead of storing them in own DB (etcd).</p>

<p><img src="../assets/images/hashicorp_jenkins_kubernetes.png" /></p>

<p>Plus, this option has the advantage of being able to put all the configurations related to your application to version control (recommended by the <a href="https://7factorconfig.org/">7 factor config</a>).
The only thing to manage in the execution environment is the credentials to access to Vault.</p>

<h3> Secrets injected directly into the JVM from Secret Manager </h3>
<p>If we compare the above methods:</p>
<ol>
  <li>The first approach with bare metal VMs force us to handle secrets manually, while the second automates the injection of the secrets to the application runtime environment.</li>
  <li>But the second still forces us to administrate the access to the vault from the runtime environments of our application.<br />
For example we have to use specific plugins/tools/agents to each environment to access to the Vault and fetch secrets.</li>
</ol>

<p>Frameworks like <a href="https://cloud.spring.io/spring-cloud-vault/reference/html/">spring-cloud-vault</a> or tools like <a href="https://homeofthewizard.github.io/vault-maven-plugin/">maven-vault-plugin</a> allows the JVM to fetch the secrets directly from the HashiCorp Vault.<br />
They are pure Java solutions, so you do not have to install anything specific to the execution environment, so can be used even in development environments.<br />
Plus your secrets are not persisted anywhere, but exists only in memory of your application.</p>

<h1> Appendix: References </h1>
<p>https://docs.oracle.com/javase/8/docs/technotes/tools/windows/java.html  <br />
https://docs.oracle.com/javase/tutorial/essential/environment/index.html<br />
https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/util/Properties.html  <br />
https://7factorconfig.org/ <br />
https://12factor.net/ <br />
https://www.twilio.com/blog/working-with-environment-variables-in-java
https://betterdev.blog/command-line-arguments-anatomy-explained/
https://developer.hashicorp.com/vault/docs/agent-and-proxy/agent<br />
https://security.stackexchange.com/questions/197784/is-it-unsafe-to-use-environmental-variables-for-secret-data<br />
https://docs.spring.io/spring-boot/docs/current/reference/html/features.html#features.external-config<br />
https://docs.spring.io/spring-framework/reference/core/beans/annotation-config/value-annotations.html</p>]]></content><author><name>Özgün ÖZ</name></author><category term="development" /><category term="java" /><summary type="html"><![CDATA[This post gives an overview of the different ways to manage configuration parameters for software applications in general, and focuses on the management of secrets with environment variables for applications written in java.]]></summary></entry><entry><title type="html">Clickhouse 101 - Data Structures and internals</title><link href="/clickhouse101_1" rel="alternate" type="text/html" title="Clickhouse 101 - Data Structures and internals" /><published>2023-08-30T12:18:00+02:00</published><updated>2023-08-30T12:18:00+02:00</updated><id>/clickhouse101_1</id><content type="html" xml:base="/clickhouse101_1"><![CDATA[<p>First article of the clickhouse 101 series. Lets deep dive into the underlying data structures and internal mechanisms of clickhouse.</p>

<p>Clickhouse is a DB that has a lot of potential and growing fast. Its use cases increase very rapidly as well. If you are into Data Analytics and Bigdata, you must explore it before too late.
This series of articles are meant to give an easy introduction to clickhouse to mainly junior level engineers, but you will still find interesting content if you are more experienced. 
The official documentation is evolving very fast. It is now complete in terms of content, and it is easier to read and browse through.<br />
So in this series we will be covering topics necessary knowledge before you dig into the official documentation, a résumé of most important points that differ clickhouse and that need attention, lastly and most importantly give experience based and neutral recommendations.</p>

<p>The series of articles will be as the following:</p>
<ol>
  <li><a href="/clickhouse101_1">Clickhouse DataStructures and Internals</a></li>
  <li>Modeling your data in Clickhouse</li>
  <li>Tradeoffs to take into account for Optimization</li>
</ol>

<p>In this first article, we will cover a bit of theory before getting into the practice. We will refresh our memory on the basics of DBs in general and the datastructures used in them. Lastly see how these structures are used in clickhouse and where does its power come from. <br />
We will cover the following topics:</p>
<ol>
  <li><a href="#whatisCH" id="whatisCHref">What is Clickhouse ?</a></li>
  <li><a href="#dsCH" id="dsCHref">Datastructures used in DBs and in Clickhouse</a></li>
  <li><a href="#internalCH" id="internalCHref">Clickhouse internal Storage and Query Mechanisms</a></li>
</ol>

<hr />

<h1 id="whatisCH"> 1. What is Clickhouse ? </h1>

<p>The best answer to that comes always from the <a href="https://clickhouse.com/docs/en/intro&quot;">official documentation</a>:</p>
<blockquote>
ClickHouse® is a high-performance, column-oriented SQL database management system (DBMS) for online analytical processing (OLAP). It is available as both an open-source software and a cloud offering.
</blockquote>

<p>To describe its differences briefly:</p>
<ul>
  <li>It is a true Column Based Database</li>
  <li>Uses data compression as a key role of its internal mechanism</li>
  <li>Stores data on disk</li>
  <li>Process data in blocks (similar data is stored together), in parallel (uses multicore CPUs) and has a distributed architecture (every instance is independent)</li>
  <li>Has SQL support (pretty much)</li>
  <li>Real time Data inserts (async data inserts do not block queries)</li>
  <li>It is Opensource</li>
</ul>

<p>In order to understand it’s true power and its differences from other DBs, lets first try to understand the basic concepts behind Column Oriented DBs and OLAP queries.</p>

<hr />

<h1 id="dsCH"> 2. Datastructures used in DBs and in Clickhouse</h1>
<h2> 2.1 Analytical Processing (OLAP) </h2>
<p>Definition from <a href="https://en.wikipedia.org/wiki/Online_analytical_processing">wikipedia</a>:</p>
<blockquote>OLAP (/ˈoʊlæp/), is an approach to answer multi-dimensional analytical (MDA) queries swiftly in computing.</blockquote>
<p>Explained simply: It requires a system where we will insert new data very frequently, and want to query adhoc slices of it in real time. But never update the inserted data.</p>

<p>If we dig further:</p>
<ul>
  <li>It requires scanning and aggregating large amount of data.<br />
Meaning that it is I/O and compute intensive (bottleneck is usually IO).</li>
  <li>Choosing different adhoc slices of data.<br />
Since we have lots of attributes and huge data, cache, index, pre-aggregation have limited value.</li>
  <li>Needs to deliver extremely fast response.<br />
Response required in as little as 20ms (Most of the time it is the backend for real-time applications)</li>
</ul>

<p>These systems present the data to the user modelled as a <a href="https://en.wikipedia.org/wiki/OLAP_cube">cube</a> in order to ease querying adhoc slices of it.
The term cube here refers to a multidimensional dataset, which is also sometimes called a <strong>hypercube</strong> if the number of dimensions is greater than three (which is usually the case).
It consists of numeric facts called measures that are categorized by dimensions. The measures are placed at the intersections of the hypercube, which is spanned by the dimensions as a vector space.</p>

<p>Let’s say we have a dataset where our fact/measure is the sales of a company, and the dimensions (attributes) of it are time of the sale, product sold, and the city where it is sold.
Each cell of the cube holds a number that represents some measure of the business, such as sales, the 3 dimensions of our cube are the 3 attributes of our sale data.</p>
<p><img src="../assets/images/OLAP_Cube.svg.png" width="256" /></p>

<p>Multiple standard operations of an OLAP cube exists to allow users analyse the data on all its aspects.</p>
<ul>
  <li>Slicing/Dicing: Filtering the data on one or multiple specific value of one of its dimension. (ex: data for only the year 1989)</li>
  <li>Drill Down/Up: allows the user to navigate among levels of data ranging from the most summarized (up) to the most detailed (down). (ex: from outdoor sport equipments to individual products)</li>
  <li>Roll-up: Involves summarizing the data along a dimension. The summarization rule might be an aggregate function, such as computing totals along a hierarchy or applying a set of formulas such as “profit = sales - expenses”</li>
  <li>Pivot allows an analyst to rotate the cube in space to see its various faces. For example, cities could be arranged vertically and products horizontally while viewing data for a particular year</li>
</ul>

<p>Olap systems under the hood, structures the DB tables in form of a <a href="https://en.wikipedia.org/wiki/Star_schema">star schema</a> (other types of schemas exists, but similar).</p>
<p><img src="../assets/images/star-schema.png" width="512" /></p>
<p>Olap systems can have their data modeled in Clickhouse with this structure as well, but a simple and single flat table is more recommended. We will see why and how clickhouse allow this later in this post.</p>

<p>Olap systems in order to give a cube like visualisation to the user on the UI or spreadsheet, based on the database structure under it, use an intermediate component that has a query engine generating the appropriate Queries (SQL for ClickHouse).
Some of the available solutions that provides the cube model on top of ClickHouse are <a href="https://cube.dev/for/clickhouse-dashboard">Cube</a> and <a href="https://www.metabase.com/data_sources/click-house">Metabase</a>(opensource), and <a href="https://opensee.io/">Opensee</a> (tailored for financial institutions).</p>
<p><img src="../assets/images/mastering_clickhouse-OLAP.png" width="1024" /></p>

<h2> 2.2 How DBs work in general </h2>
<p>Before we see how Column-Oriented DBs work (like clickhouse), lets refresh our memories on some base concepts necessary to understand how DBs store data, and how they look up for them when queried.</p>

<p>Lets illustrate how those work using the following DB table.</p>
<p><img src="../assets/images/mastering_clickhouse-table.png" /></p>

<h3>Partitionning</h3>
<p>It allows a table to be subdivided and stored into smaller pieces, where each piece of such a database object is called a partition. Each partition has its own name, and may optionally have its own storage characteristics (maybe stored on separate physical or virtual disk for example). The data of partitioned tables is divided into units that can be spread across more than one filegroup in a database. The data is partitioned horizontally, so that groups of rows are mapped into individual partitions.</p>
<p><img src="../assets/images/mastering_clickhouse-partitioning-tables.png" /></p>

<h3>Indexing</h3>
<p>I would like to state first the definition of the word <a href="https://en.wikipedia.org/wiki/Index_(publishing)">“index”</a>:</p>
<blockquote>
An index is a list of words or phrases ('headings') and associated pointers ('locators') to where useful material relating to that heading can be found in a document or collection of documents. Examples are an index in the back matter of a book and an index that serves as a library catalog. An index differs from a word index, or concordance, in focusing on the subject of the text rather than the exact words in a text, and it differs from a table of contents because the index is ordered by subject, regardless of whether it is early or late in the book, while the listed items in a table of contents is placed in the same order as the book.[1]
</blockquote>

<p>Now we can understand its usage <a href="https://en.wikipedia.org/wiki/Database_index">in DBs</a>.</p>
<blockquote>
A database index is a data structure that improves the speed of data retrieval operations on a database table at the cost of additional writes and storage space to maintain the index data structure.
</blockquote>

<p>Indexes in DBs are created using the following two info:<br />
<strong>Search key:</strong> A copy of the primary key, the values of the search key is stored in sorted order to be able to search on them easily.<br />
<strong>Data ref:</strong> or pointer, which contains addresses of disk block where the value row of that particular key is stored.    <br />
<em>NOTE: the pointed data itself may or may not be ordered.</em></p>

<p><img src="../assets/images/mastering_clickhouse-indexing-tables.png" /></p>

<p>There exists two types of index file organisations:<br />
<strong> 1. Sequential file organisation </strong><br />
<strong> 2. Hash file organisation </strong></p>

<p>Lets illustrate how those organisations work using our DB table.</p>
<p><img src="../assets/images/mastering_clickhouse-indexing-table.png" /></p>

<p>We will start with Hash file, and finish with Sequential file index, cause the latest is the one used in ClickHouse.</p>

<p><strong>Hash file organisation:</strong>
Is an index that uses a hash function with search keys as parameters to generate the direct addresses of data record on disk.
We give the definition of a hash function later in this article.</p>

<p><img src="../assets/images/mastering_clickhouse-hash-file.png" /></p>

<p>As it is the case for all Hash based organisations, the data stored is scattered, non-ordered, so cannot be compressed. Lots of space is not used and wasted.</p>

<p><strong>Sequential file index organisation:</strong>
In this, the indices are based on a sorted ordering of the values. These are generally fast and a more traditional type of storing mechanism. These Ordered or Sequential file organizations might store the data in a dense or sparse format.</p>

<p><img src="../assets/images/mastering_clickhouse-sequential-file.png" /></p>

<p><strong>Dense index: </strong>
We can see that the index has an entry for every first name in the table. If we want to look up a user with the first name “Arnaud,” then we perform a binary search on the index and read the location of the data. In contrast, a sparse index only has entries for some of the table rows.</p>

<p><strong>Sparse index:</strong><br />
We can see that our sparse index only has 2 entries (one for each page). Now, if we want to find the row for “Arnaud,” we can perform a binary search on our index to find that it falls between “Anne” and “Mathieu”. After discovering those bounds, we go to the page starting with “Anne” and begin scanning for Arnaud’s row. Notice that the data is now sorted on the right side for this example. This sorting is a limitation of the sparse index. A sparse index requires ordered data; otherwise, the scanning step would be impossible.</p>

<p>Dense indexes require more maintenance than sparse indexes at write-time. Since every row must have an entry, the database must maintain the index on inserts, updates, and deletes. Having an entry for every row also means that dense indexes will require more memory. The benefit of a dense index is that values can be quickly found with just a binary search. Dense indexes also do not impose any ordering requirements on the data.
Sparse indexes require less maintenance than dense indexes at write-time since they only contain a subset of the values. This lighter maintenance burden means that inserts, updates, and deletes will be faster. Having fewer entries also means that the index will use less memory. Finding data is slower since a scan across the page typically follows the binary search. Sparse indexes are also only an option when working with ordered data.</p>

<h2> 2.3. How Row and Column based Databases work</h2>
<p>Lets say we have the following DB table.</p>
<p><img src="../assets/images/mastering_clickhouse-DB table.png" /></p>

<p>Row oriented DBs, as the name suggest, store data in rows. It is easy to write and read entire rows. But not so much if you want to read adhoc Query or do aggregation on particular columns, like analytical queries does. 
In that case you have to bring all columns for all rows, read multiple disks potentially, then filter on columns you are interested, then only aggregate.</p>

<p>For example if we want to add a new row in a Row oriented DB, we would be appending the data like below.<br />
Reading from it would require reading all columns.</p>
<p><img src="../assets/images/mastering_clickhouse-Row%20based%20DBs.png" /></p>

<p>Now imagine if we just wanted to sum the ages in this table. We would have to read all data columns first to get the data we need. Also if we partition the table into multiple disks, this would mean that the computer would need to read from multiple disks to get the data necessary.</p>

<p>Now lets compare the same scenario for the same data stored on a Column Oriented design.</p>
<p><img src="../assets/images/mastering_clickhouse-Column%20based%20DBs.png" /></p>

<p>If we want to add new data, we would have to plug each column’s data into where it belongs. If we use a single disk, we would have to bring everything in memory to do this. But it is the same with Row Oriented design. Column Oriented design has its advantage if we partition data into multiple disks.</p>

<p>As we can see from above, when reading a single column for aggregating on it, we just need one disk, and the data loaded in memory is much less.</p>

<p>Now, If we want to save space on our DB and secure data, we may consider data encoding and compression. So lets see what that means.</p>

<h2> 2.4. Compression ? Encoding ? Encryption ? Hashing ? Indexing ? Huh ?!</h2>
<p>Compression from <a href="https://en.wikipedia.org/wiki/Data_compression">wikipedia</a>:</p>
<blockquote>
In information theory, data compression, source coding, or bit-rate reduction is the process of encoding information using fewer bits than the original representation. Any particular compression is either lossy or lossless. Lossless compression reduces bits by identifying and eliminating statistical redundancy. No information is lost in lossless compression. Lossy compression reduces bits by removing unnecessary or less important information.[3] Typically, a device that performs data compression is referred to as an encoder, and one that performs the reversal of the process (decompression) as a decoder.
</blockquote>
<p>As the description above says, compression is a type of encoding. So lets start with that first.</p>

<h3> What is Encoding ? </h3>
<p>Encoding data is a process involving changing data into a new format using a scheme. Encoding is a reversible process and data can be encoded to a new format and decoded to its original format. Encoding typically involves a publicly available scheme that is easily reversed. Encoding data is typically used to ensure the integrity and usability of data and is commonly used when data cannot be transferred in its current format between systems or applications. Encoding is not used to protect or secure data because it is easy to reverse.</p>

<p><strong>An example of encoding - Base64  </strong>
It is a method to encode byte sequences to a string. Also known as ASCII encoding, it converts binary data to ASCII strings.
But it is not the ideal choice for security as it can easily be decoded.
Instead, it serves as an easy way to make non HTTP compatible data types readable (image, audio ect…)
We can attach a base64 encoded image into an xml or email.
It provides no checksum or anything for storage value, so it is really used for transport.</p>

<p><strong> Another example of encoding - UTF </strong>
It is a method used for storage. 
UTF Stands for “Unicode Transformation Format”. The UTF encoding standards, such as UTF-8, 16 ect., are used to convert Unicode character into numerals. <strong>Unicode</strong> is a codded character set. A set of characters and mapping between those characters and their integer codes representing them.</p>

<p>Lets say we want to store the following character in our hard drive.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">character:              汉
unicode:                U+6C49
unicode in binary:      01101100  01001001</code></pre></figure>

<p>When we decide to store a character in our hard drive, we can simply put its binary value. When the computer reads it, it has no idea how to parse this. It is one byte 2 charcter ? or two bytes 1 character ? so we need an encoding to tell the computer how to treat it when read. This is where UTF-8 like encodings comes in.</p>

<p>Binary Format of Byte Sequences in UTF-8 are like the following:</p>
<p><img src="../assets/images/mastering_clickhouse-utf-table.png" /></p>

<p>Which format from the above table we will use depends on how many bits we need to write in binary the unicode of our character (for 汉 we need 2bytes/16bits).  <br />
So to Encode 汉 in UTF-8 we will use the 3bytes format which has 16bits free:</p>
<p><img src="../assets/images/mastering_clickhouse-utf-encoding.png" /></p>

<p>Encoding of 汉 in UTF-8   =  11100110 10110001 10001001</p>

<h3> What is Encryption ? </h3>
<p>Encryption is an encoding technique for a specific need, which is to allow only authorized users with a key or password to decrypt the data and reveal its original. Encryption is used when data needs to be protected so those without the decryption keys cannot access the original data. For example, when data is sent to a website over HTTPS it is encrypted using the public key type. While encryption does involve encoding data, the two are not interchangeable terms, encryption is always used when referring to data that has been securely encoded. Encoding data is used only when talking about data that is not securely encoded.</p>

<p><strong>An example of encryption is: AES</strong>
AES is the Advanced Encryption Standard and is a symmetric key encryption.
We will see, in later articles of this series that Clickhouse, if needed, allows encrypting the data at rest with an AES key.</p>

<p>If you would like to dig deeper into encryption, the subject is very wast and is a scientific field apart (Cryptography), but I could suggest <a href="https://en.wikipedia.org/wiki/Encryption">this article</a> as a good beginning.</p>

<h3> What is Hashing ? </h3>
<p>Hashing is a one-way process where data is “encoded”, using a hash-function.
The best definition of a hash function comes from <a href="&quot;https://en.wikipedia.org/wiki/Hash_function&quot;">wikipedia</a>:</p>
<blockquote>
A hash function is any function that can be used to map data of arbitrary size to fixed-size values, though there are some hash functions that support variable length output. The values returned by a hash function are called hash values, hash codes, digests, or simply hashes. The values are usually used to index a fixed-size table called a hash table. Use of a hash function to index a hash table is called hashing or scatter storage addressing.
</blockquote>
<p>As we can understand from that definition, hashing can be using to index data in Databases, which we already saw above.</p>

<p>But on top of that Hashing is also commonly used to verify the integrity of data, commonly referred to as a checksum, and it is the recommended data transformation technique in authentication processes for computer systems and applications.
If you are interested to those other usages outside our scope, a good article can be found <a href="https://www.packetlabs.net/posts/encryption-encoding-and-hashing/#:~:text=In%20addition%20to%20verifying%20the,of%20the%20%E2%80%9Csalted%20password%E2%80%9D">here</a>.</p>

<h3> What is Compression ? </h3>
<p>Compression mechanisms seperates into two, losseless and lossy. As the names suggest, lossless types can compress/decompress data and reconstruct it without any data loss. ex: zip archives which includes tarball(tar.xz) compression for unix systems.</p>

<p><strong> An example of Compression - Dictionary Encoding:</strong>
Most primitive, yet most powerful encoding. It compresses really good, but the dictionary built is usually for a specific purpose. Otherwise too big an not optimal. A common usage is Brotli algorithm used to compress web pages.</p>

<table>
  <thead>
    <tr>
      <th>key</th>
      <th>encoded value</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>fondue</td>
    </tr>
    <tr>
      <td>2</td>
      <td>spageti</td>
    </tr>
    <tr>
      <td>3</td>
      <td>döner</td>
    </tr>
  </tbody>
</table>

<p><strong>An example of Compression - Bitmap Compression / Run-length Encoding:</strong>
It is a form of losseless compression in which “runs” of data (sequences in which the same data value occurs in many consecutive data elements) are stored as a single data value and count.</p>

<figure class="highlight"><pre><code class="language-text" data-lang="text">aaaab -&gt; 4a1b</code></pre></figure>

<h2> 2.5. Why sorting is important in C-Oriented DBs ? </h2>
<p>When doing adHoc queries, there are different sort orders of data that would improve performance. We might want to list data ordered by date, for instance both in asc and desc order. In R-DBs, indexes can be created but data is rarely ordered with multiple sort orders. In C-DBs you can.</p>
<p><img src="../assets/images/mastering_clickhouse-ColumnOriented-ReadStores.png" /></p>

<p>These ways of storing data are called “projections”.
There are multiple benefits beyond query performance. Having multiple copies of same data allows fault tolerance.</p>

<p>The above diagram seems difficult to update, and it is. But that is why usually C-DBs have the main table called “writable store (WS)” and multiple “readable stores (RS)”.
The WS has data ordered in order of injection. It simply appends new data to the existing one. It has a tuple mover that updates the RS with the updates to the WS.
The RS can have multiple projections. The tuple mover navigates to the projections and append data to the proper place.</p>
<div class="alert">
    <div style="margin-left: 0.7em;">
        <!--<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </svg>--> 
        Warning:
        <em>This architecture requires that the partially inserted data to the RS should be ignored by the incoming adhoc queries, until the insertion is completed</em>
    </div>
</div>

<p>As seen above since we can sort column data. This allows us to compress with run-lenght encoding to reduce the data in terms of bit and store less data on our hard drive. 
Also since we encode data, each piece of data is the same number of bits long. So we can further compress: each data piece is shown as, the number of piece of data times the number of bits each data piece has.
All of that allows our DB to read less data from the disk when querying it ! isn’t that beautiful ?</p>

<h2> 2.6. Résumé </h2>
<p>In C-Oriented DBs:</p>

<ol>
  <li>Data is partitioned by columns.</li>
  <li>Column Data is stored ordered.</li>
  <li>Since data is ordered, so we can us Sparse index.</li>
  <li>Data is ordered, so we can compress it.</li>
</ol>

<p>Now we have learned a lot about C-Oriented Columns. How things work really in clickhouse ?</p>

<hr />

<h1 id="internalCH"> 3. Clickhouse Internal Storage and Query Mechanism</h1>
<p>Now lets take a practical example to illustrate the power of clickhouse.<br />
Say we have the table below, containing 8.87 million entry:</p>
<p><img src="../assets/images/mastering_clickhouse-partitioned-table.png" /></p>

<p>If we execute the query below on that table:</p>

<figure class="highlight"><pre><code class="language-sql" data-lang="sql"><span class="k">SELECT</span> <span class="n">Carrier</span><span class="p">,</span>
<span class="n">toYear</span><span class="p">(</span><span class="n">FlightDate</span><span class="p">)</span> <span class="k">as</span> <span class="nb">Year</span><span class="p">,</span>
<span class="k">sum</span><span class="p">(</span><span class="n">canceled</span><span class="p">)</span><span class="o">/</span><span class="k">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="k">as</span> <span class="n">canceled</span>
<span class="k">FROM</span> <span class="n">flights_ontime</span>
<span class="k">WHERE</span> <span class="nb">Year</span> <span class="o">=</span> <span class="mi">2017</span>
<span class="k">GROUP</span> <span class="k">BY</span> <span class="n">Carrier</span><span class="p">,</span> <span class="nb">Year</span>
<span class="k">HAVING</span> <span class="n">cancelled</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">.</span><span class="mi">0</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">Carrier</span></code></pre></figure>

<p>If we:</p>
<ul>
  <li>read every row 				=&gt; 	59GB  	%100</li>
  <li>read only 3 columns 		=&gt;	1,7GB	%3</li>
  <li>read 3 cols compressed		=&gt;	21MB	%0,035</li>
  <li>read 3 cols comp 8 threads	=&gt;	2,6MB	%0,0044</li>
</ul>

<p>In traditional relational database management systems, the primary index would contain one entry per table row. For our data set this would result in the primary index - often a B(+)-Tree data structure - containing 8.87 million entries. Such an index allows the fast location of specific rows, resulting in high efficiency for lookup queries and point updates. Searching an entry in a B(+)-Tree data structure has average time complexity of O(log2 n). For a table of 8.87 million rows, this means 23 steps are required to locate any index entry. This capability comes at a cost: additional disk and memory overheads and higher insertion costs when adding new rows to the table and entries to the index (and also sometimes rebalancing of the B-Tree).</p>

<p>Considering the challenges associated with B-Tree indexes, table engines in ClickHouse utilise a different approach. The ClickHouse MergeTree Engine Family has been designed and optimized to handle massive data volumes. These tables are designed to receive millions of row inserts per second and store very large (100s of Petabytes) volumes of data. Data is quickly written to a table part by part, with rules applied for merging the parts in the background. In ClickHouse each part has its own primary index. When parts are merged, then the merged part’s primary indexes are also merged. At the very large scale that ClickHouse is designed for, it is paramount to be very disk and memory efficient. Therefore, instead of indexing every row, the primary index for a part has one index entry (known as a ‘<strong>mark</strong>’) per group of rows (called ‘<strong>granule</strong>’) - this technique is called sparse index.</p>

<p>Sparse indexing is possible because ClickHouse is storing the rows for a part on disk ordered by the primary key column(s). Instead of directly locating single rows (like a B-Tree based index), the sparse primary index allows it to quickly (via a binary search over index entries) identify groups of rows that could possibly match the query. The located groups of potentially matching rows (granules) are then in parallel streamed into the ClickHouse engine in order to find the matches. This index design allows for the primary index to be small (it can, and must, completely fit into the main memory), whilst still significantly speeding up query execution times: especially for range queries that are typical in data analytics use cases.</p>
<p><img src="../assets/images/mastering_clickhouse-partitioning.png" /></p>

<p>For data processing purposes, a table’s column values are logically divided into granules. A granule is the smallest indivisible data set that is streamed into ClickHouse for data processing. This means that instead of reading individual rows, ClickHouse is always reading (in a streaming fashion and in parallel) a whole group (granule) of rows.
The following diagram shows how the (column values of) 8.87 million rows of our table are organized into 1083 granules, as a result of the table’s DDL statement containing the setting index_granularity (set to its default value of 8192).
The primary index is created based on the granules shown in the diagram above. This index is an uncompressed flat array file (primary.idx), containing so-called numerical index marks starting at 0.
The diagram below shows that the index stores the primary key column values (the values marked in orange in the diagram above) for each first row for each granule. Or in other words: the primary index stores the primary key column values from each 8192nd row of the table (based on the physical row order defined by the primary key columns). For example
the first index entry (‘mark 0’ in the diagram below) is storing the key column values of the first row of granule 0 from the diagram above,
the second index entry (‘mark 1’ in the diagram below) is storing the key column values of the first row of granule 1 from the diagram above, and so on.</p>

<p>When a query is filtering on a column that is part of a compound key and is the first key column, then ClickHouse is running the binary search algorithm over the key column’s index marks.</p>

<p>As discussed above, ClickHouse is using its sparse primary index for quickly (via binary search) selecting granules that could possibly contain rows that match a query.
This is the first stage (granule selection) of ClickHouse query execution.
In the second stage (data reading), ClickHouse is locating the selected granules in order to stream all their rows into the ClickHouse engine in order to find the rows that are actually matching the query.</p>

<p>In ClickHouse the physical locations of all granules for our table are stored in mark files. Similar to data files, there is one mark file per table column.
The primary index is a flat uncompressed array file (primary.idx), containing index marks that are numbered starting at 0.
Similarly, a mark file is also a flat uncompressed array file (*.mrk) containing marks that are numbered starting at 0.
The binary data file contains the actual data, but in a compressed format.
Once ClickHouse has identified and selected the index mark for a granule that can possibly contain matching rows for a query, a positional array lookup can be performed in the mark files in order to obtain the physical locations of the granule.</p>

<p>Each mark file entry for a specific column is storing two locations in the form of offsets:
The first offset (‘block_offset’) is locating the block in the compressed column data file that contains the compressed version of the selected granule. This compressed block potentially contains a few compressed granules. The located compressed file block is uncompressed into the main memory on read.
The second offset (‘granule_offset’) from the mark-file provides the location of the granule within the uncompressed block data.
Because compressed blocks contains data for multiple granules.</p>

<p>All the 8192 rows belonging to the located uncompressed granule are then streamed into ClickHouse for further processing.</p>
<p><img src="../assets/images/mastering_clickhouse-parts-internals.png" /></p>

<h3>Why MARK Files ?</h3>
<p>Why does the primary index not directly contain the physical locations of the granules that are corresponding to index marks?<br />
Because at that very large scale that ClickHouse is designed for, it is important to be very disk and memory efficient.<br />
The primary index file needs to fit into the main memory.<br />
For our example query, ClickHouse used the primary index and selected a single granule that can possibly contain rows matching our query. Only for that one granule does ClickHouse then need the physical locations in order to stream the corresponding rows for further processing.<br />
Furthermore, this offset information is only needed for the UserID and URL columns.<br />
Offset information is not needed for columns that are not used in the query e.g. the EventTime.<br />
For our sample query, ClickHouse needs only the two physical location offsets for granule 176 in the UserID data file (UserID.bin) and the two physical location offsets for granule 176 in the URL data file (URL.bin).<br />
The indirection provided by mark files avoids storing, directly within the primary index, entries for the physical locations of all 1083 granules for all three columns: thus avoiding having unnecessary (potentially unused) data in main memory.</p>

<hr />

<h1>Appendix: References</h1>

<p>https://wikipedia.com<br />
https://olap.com/learn-bi-olap
https://www.kdnuggets.com/2018/09/olap-queries-sql-refresher.html
https://stackoverflow.com/questions/643694/what-is-the-difference-between-utf-8-and-unicode
https://dataschool.com/data-modeling-101/row-vs-column-oriented-databases/<br />
https://www.joelonsoftware.com/2003/10/08/the-absolute-minimum-every-software-developer-absolutely-positively-must-know-about-unicode-and-character-sets-no-excuses/<br />
https://clickhouse.com/docs/en/optimize/sparse-primary-indexes#an-index-design-for-massive-data-scales</p>]]></content><author><name>Özgün ÖZ</name></author><category term="development" /><category term="system" /><summary type="html"><![CDATA[First article of the clickhouse 101 series. Lets deep dive into the underlying data structures and internal mechanisms of clickhouse.]]></summary></entry><entry><title type="html">Understanding Maven for plugin Development</title><link href="/maven_plugin_development" rel="alternate" type="text/html" title="Understanding Maven for plugin Development" /><published>2023-08-30T12:18:00+02:00</published><updated>2023-08-30T12:18:00+02:00</updated><id>/maven_plugin_development</id><content type="html" xml:base="/maven_plugin_development"><![CDATA[<p>Deep dive into maven’s internals to help the development of plugins</p>

<p>This will be probably the first post of a series about how maven works and how to contribute to its ecosystem.<br />
In this post, I will talk about the core components and internal mechanism of maven that developers should know if they want to develop plugins.
While developing my first plugins I have had a hard time to find all information in details in the documentation. I even ended up contributing to the maven documentation.
So the idea here is to give you important headlines and an introduction to the core features, and pointing you to detailed documentation links if you want to go further.</p>

<h1 id="quick-reminder">Quick reminder</h1>
<h2 id="what-is-maven-">What is MAVEN ?</h2>
<p><a href="https://maven.apache.org/what-is-maven.html">Maven</a> is one of the most used build tools in the Java echo system. While helping us build our project, it does a lot more than just packaging it.<br />
You probably used a few of its plugins. Failsafe and Surefire plugins are most commonly used ones explicitly. 
But Maven is actually conceived with a plugin based architecture. Meaning everything you do with maven is running plugin.<br />
Even the basic commands you use, like <code class="language-plaintext highlighter-rouge">mvn clean install</code> are actually using <code class="language-plaintext highlighter-rouge">clean</code> and <code class="language-plaintext highlighter-rouge">install</code> plugins. See <a href="https://maven.apache.org/plugins/index.html">here</a> for more details.
This is what allows maven to expand its usage so easily.<br />
You sometimes even use maven outside the build context, on your CI or deployment pipelines. <a href="https://docs.sonarsource.com/sonarqube/latest/analyzing-source-code/scanners/sonarscanner-for-maven/">sonar-scanner</a> or <a href="https://docs.liquibase.com/tools-integrations/maven/home.html">liquibase</a> plugins are good examples.</p>

<p>If you want to develop your own plugin to add new features to maven and use it on your CI or deployment pipelines, the official <a href="https://maven.apache.org/plugin-developers/index.html">documentation</a> is always a good start.
You might find some pages out of date. Maven is an open sourced project developed mainly by the community. While writing this post, I am also trying to update it. Please do the same.
Also please have a look <a href="https://maven.apache.org/plugin-developers/common-bugs.html">here</a>, so you do not fall into common errors when starting with maven.</p>

<h2 id="how-maven-works-">How Maven works ?</h2>
<p>You probably all know but I will repeat for the sake of introduction, everything starts by defining our maven build writing a <code class="language-plaintext highlighter-rouge">pom.xml</code>.<br />
We typically define the dependencies and resources we need to build our application, and the plugins/extensions we need part of our build process to do so.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>
         <span class="na">child.project.url.inherit.append.path=</span><span class="s">..</span> <span class="nt">&gt;</span>
<span class="nt">&lt;modelVersion/&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>com.example<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>my demo app<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0.0<span class="nt">&lt;/version&gt;</span>
    <span class="nt">&lt;packaging&gt;</span>jar<span class="nt">&lt;/packaging&gt;</span>
    
    <span class="nt">&lt;name&gt;</span>maven-demo-app<span class="nt">&lt;/name&gt;</span>
    <span class="nt">&lt;description&gt;</span>an example of pom configuration<span class="nt">&lt;/description&gt;</span>
    
    ...
    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId/&gt;</span>
            <span class="nt">&lt;artifactId/&gt;</span>
            <span class="nt">&lt;version/&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>
    ...

    <span class="nt">&lt;build&gt;</span>
        ...
        <span class="nt">&lt;resources&gt;</span>
            <span class="nt">&lt;resource&gt;</span>
                <span class="nt">&lt;directory/&gt;</span>
                <span class="nt">&lt;includes/&gt;</span>
                <span class="nt">&lt;excludes/&gt;</span>
            <span class="nt">&lt;/resource&gt;</span>
        <span class="nt">&lt;/resources&gt;</span>
       ...
        <span class="nt">&lt;plugins&gt;</span>
            <span class="nt">&lt;plugin&gt;</span>
                <span class="nt">&lt;groupId/&gt;</span>
                <span class="nt">&lt;artifactId/&gt;</span>
                <span class="nt">&lt;version/&gt;</span>
            <span class="nt">&lt;/plugin&gt;</span>
        <span class="nt">&lt;/plugins&gt;</span>
        ...
        <span class="nt">&lt;extensions&gt;</span>
            <span class="nt">&lt;extension&gt;</span>
                <span class="nt">&lt;groupId/&gt;</span>
                <span class="nt">&lt;artifactId/&gt;</span>
                <span class="nt">&lt;version/&gt;</span>
            <span class="nt">&lt;/extension&gt;</span>
        <span class="nt">&lt;/extensions&gt;</span>
    <span class="nt">&lt;/build&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</code></pre></div></div>

<p>See <a href="https://maven.apache.org/ref/3.9.6/maven-model/maven.html">here</a> for the full API.</p>

<p>When we launch a maven command, typically on cli:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&gt;</span> mvn <span class="nt">-help</span>
usage: mvn <span class="o">[</span>options] <span class="o">[</span>&lt;goal<span class="o">(</span>s<span class="o">)&gt;]</span> <span class="o">[</span>&lt;phase<span class="o">(</span>s<span class="o">)&gt;]</span>
</code></pre></div></div>
<p>Maven will read our pom.xml to see what we want to do, depending on what <em>command</em> we have triggered.<br />
A <strong>Goal</strong> is simply an action made available via a <strong>plugin</strong>.<br />
A <strong>Phase</strong> is part of maven <strong>Lifecycle</strong>, and we can associate goals to a phase as we want.<br />
So using Lifecycles and phases we can trigger multiple goals to achieve what we want. A detailed explanation on Lifecycles can be found <a href="https://maven.apache.org/ref/3.9.6/maven-core/lifecycles.html">here</a>.</p>

<p>For example when we launch <code class="language-plaintext highlighter-rouge">mvn install</code>, maven will launch a list of phases in a specific order that are part of the default lifecycle, and the plugin goals associated to each phase (by default or specified in our POM).
It will gather the sources and resources to build the classpath, compile the project, launch tests if any, package the app, and install it in our local repository.</p>

<p>As usually does all package managers, maven uses repositories to:</p>
<ul>
  <li>Fetch the dependencies and plugins we need when building our own packages.</li>
  <li>Deploy our application when packaged</li>
</ul>

<p>This is usually configured in a separate <a href="https://maven.apache.org/ref/3.9.6/maven-settings/settings.html">config</a>, 
the <code class="language-plaintext highlighter-rouge">settings.xml</code> which is specific to each environment and not published on version control, since it contains credentials to access the repository servers and local configs.</p>

<div class="important">
    <div style="margin-left: 0.7em;">
        <strong>Important:</strong>
        <em>As we can understand from the above, there are multiple components interacting here to build our application. 
        Maven’s core component is what orchestrates all this lifecycles logic, and each plugin is a separately packaged component.</em>
    </div>
</div>

<hr />

<h1 id="inside-maven">Inside Maven</h1>
<p>Now that we have remembered how to use it, now lets get to the main subject and dig inside Maven to see how it works.</p>

<h2 id="1-maven-core">1. Maven Core</h2>
<p>Maven is a command line tool, written in java and packaged as an executable that will run using your JRE. <br />
If you check the content of the <code class="language-plaintext highlighter-rouge">mvn</code> script that is actually launched when typing it on the cli, you will see that it is basically a bash script running a java process.</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nb">exec</span> <span class="s2">"</span><span class="nv">$JAVACMD</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nv">$MAVEN_OPTS</span> <span class="se">\</span>
  <span class="nv">$MAVEN_DEBUG_OPTS</span> <span class="se">\</span>
  <span class="nt">-classpath</span> <span class="s2">"</span><span class="k">${</span><span class="nv">CLASSWORLDS_JAR</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="s2">"-Dclassworlds.conf=</span><span class="k">${</span><span class="nv">MAVEN_HOME</span><span class="k">}</span><span class="s2">/bin/m2.conf"</span> <span class="se">\</span>
  <span class="s2">"-Dmaven.home=</span><span class="k">${</span><span class="nv">MAVEN_HOME</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="s2">"-Dlibrary.jansi.path=</span><span class="k">${</span><span class="nv">MAVEN_HOME</span><span class="k">}</span><span class="s2">/lib/jansi-native"</span> <span class="se">\</span>
  <span class="s2">"-Dmaven.multiModuleProjectDirectory=</span><span class="k">${</span><span class="nv">MAVEN_PROJECTBASEDIR</span><span class="k">}</span><span class="s2">"</span> <span class="se">\</span>
  <span class="k">${</span><span class="nv">CLASSWORLDS_LAUNCHER</span><span class="k">}</span> <span class="k">${</span><span class="nv">MAVEN_ARGS</span><span class="k">}</span> <span class="s2">"</span><span class="nv">$@</span><span class="s2">"</span>

</code></pre></div></div>

<p>Without digging in too much details here, I will point you to the official documentation if you want further details.
The following <a href="https://maven.apache.org/ref/3.9.6/">documentation</a> shows in details its internal components.</p>
<p><img src="../assets/images/maven.drawio.png" /></p>
<p>This is highly simplified version that shows only the main components that we will talk about.
The <b style="color:steelblue">blue</b> boxes are the maven components and the <b style="color:sandybrown">orange</b> ones are external libraries used by maven.</p>

<p>The <strong>Distribution</strong> is the full package we get when we download maven executables.</p>

<p>The <strong>Core</strong> component is where we implement all the maven lifecycle and phase logic.
It interacts with the other components to get the information necessary to build the lifecycles (maven and project settings, plugin settings ect.).<br />
This is also where we have the Class Loader hierarchy and extensions setup for the maven lifecycles execution, which we will dig deeper further in this article.</p>

<p>The <strong>PluginAPI</strong> is basically where we make the interface between the maven lifecycles and the goals to execute from the plugins. We are going to use this API to code our plugins so maven can use them.
The <a href="https://maven.apache.org/ref/3.9.6/maven-core/index.html">core</a> component on the schema is the main application that will manage everything necessary for the build process defined in your pom.xml.<br />
As you already guessed from the title of this article, we will talk in more details about this component further.</p>

<p>The <strong>Settings</strong> components is basically what you set in your maven settings, ` ~/.m2/settings.xml` plus the settings overridden on the cli.</p>

<p>The <strong>Resolver</strong> is a component for working with artifact repositories and dependency resolution. 
It deals with the specification of local repository, remote repository, developer workspaces, artifact transports, and artifact resolution.</p>

<p>The <strong>Model</strong> is basically your model for Maven POM (Project Object Model), where you define your project settings.</p>

<p>The <strong>SISU</strong> components is where we manage the dependency injection of objects in maven plugins/extensions. It a crucial components in the plugin system, 
and we must understand how it works in case we are building extensions.</p>

<h2 id="2-maven-classloader-system">2. Maven Classloader system</h2>
<p>I will repeat it probably multiple times, but It is why I love maven, so I won’t get tired of saying it: <em>maven is a plugin based system</em>.</p>

<p>Lets quickly remind what is a classloader before explaining how maven uses it.<br />
A <a href="https://en.wikipedia.org/wiki/Java_Classloader">ClassLoader</a> in java is a code that runs as part of the JRE, 
and it is responsible for finding the class files necessary for the execution of the application and load them in the JVM.</p>

<p>Maven uses a classloading hierarchy to separates the class-worlds of its core, and its plugins. What that means is that, 
with this classloader hierarchy, we prevent exposing all the classes/packages used by the core, to the plugins.<br />
This level of isolation allows maven to work securely while allowing its extension by third party plugins developed by mere human beings like me, and preventing I break everything in it.</p>
<p><img src="../assets/images/maven-classWorlds.drawio.png" /></p>

<p>Basically when booting maven, as we can see from the <code class="language-plaintext highlighter-rouge">mvn</code> script above, we launch the jar of the 
<a href="https://codehaus-plexus.github.io/plexus-classworlds/">plexus-classworld</a> framework that is building this classLoader hierarchy, located in <code class="language-plaintext highlighter-rouge">${maven.home}/boot/plexus-classworlds-*.jar</code>.<br />
This creates the <strong>System ClassLoader</strong>. Then the different classLoaders are built, maven core, project and plugin classLoaders (there are actually more than that, but we will simplify for an introduction).</p>

<p>Content of this <strong>Core Classloader</strong> is configured in <code class="language-plaintext highlighter-rouge">${maven.home}/bin/m2.conf</code> and contains jars that constitutes a maven installation, located in <code class="language-plaintext highlighter-rouge">${maven.home}/lib/*.jar</code>. 
This core class loader hosts both the public API of Maven and internal utility classes. Core extensions classloaders use Maven Core classloader as the parent and have access to both exported and internal Maven Core classes.</p>

<p>We can add other elements to this class loader via <strong><a href="https://maven.apache.org/examples/maven-3-lifecycle-extensions.html">Core Extensions</a></strong>. 
Those classes will be available for maven core component, and all the plugins in the project through the child classloader Maven API.
We will talk more in details further how the extensions works. Each core extension is loaded in a separate classloader and there is no mechanism to share classes among core extensions.</p>

<p>The child class loader, <strong>Maven API ClassLoader</strong>, can only access the public Maven API from the core class loader, 
i.e. roughly only classes from the package org.apache.maven and its subpackages are available to the child class loader.</p>

<p><strong>Project ClassLoader</strong> use Maven API classloader as the parent and import exported classes from project build extension realms. 
In case a project uses no build extensions and hence has no need for a dedicated project class loader, this class loader will technically not be created.</p>

<p>For each plugin used by a project, a <strong>Plugin ClassLoader</strong> is created as a child of the project class loader. If the project has no extensions and as such no project class loader, 
the plugin class loader will be a direct child of the Maven API ClassLoader instead.</p>

<p>A detailed documentation can be found <a href="https://maven.apache.org/guides/mini/guide-maven-classloading.html#Core_Classloader">here</a> on the official website.</p>

<h2 id="3-maven-dependency-injection">3. Maven Dependency Injection</h2>
<p>Maven uses <a href="https://projects.eclipse.org/projects/technology.sisu"><strong>SISU</strong></a>, which is a DI Container implementation based on the <a href="https://code.google.com/p/google-guice/">Google Guice</a>. 
It allows using standard <a href="">JSR330 annotations</a> for declaring and injecting the objects we need in our classes.<br />
The <a href="https://eclipse.github.io/sisu.plexus/">doc</a> here (that I have contributed) explains how to use the different annotations.</p>

<p>It basically allows you to inject components in your Mojo like the following:</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="nn">org.apache.maven.plugins</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">javax.inject.Inject</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.apache.maven.plugin.AbstractMojo</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.maven.plugin.MojoExecutionException</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.maven.plugins.annotations.LifecyclePhase</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.maven.plugins.annotations.Mojo</span><span class="o">;</span>

<span class="nd">@Mojo</span><span class="o">(</span> <span class="n">name</span> <span class="o">=</span> <span class="s">"hello"</span><span class="o">,</span> <span class="n">defaultPhase</span> <span class="o">=</span> <span class="nc">LifecyclePhase</span><span class="o">.</span><span class="na">VALIDATE</span><span class="o">,</span> <span class="n">requiresProject</span> <span class="o">=</span> <span class="kc">false</span> <span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyMojo</span> <span class="kd">extends</span> <span class="nc">AbstractMojo</span>
<span class="o">{</span>

    <span class="kd">private</span> <span class="nc">MyComponent</span> <span class="n">component</span><span class="o">;</span>

    <span class="nd">@Inject</span>
    <span class="kd">public</span> <span class="nf">MyMojo</span><span class="o">(</span> <span class="nc">MyComponent</span> <span class="n">component</span> <span class="o">)</span>
    <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">component</span> <span class="o">=</span> <span class="n">component</span><span class="o">;</span>    
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">execute</span><span class="o">()</span>
        <span class="kd">throws</span> <span class="nc">MojoExecutionException</span>
    <span class="o">{</span>
        <span class="n">component</span><span class="o">.</span><span class="na">hello</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>According to the documentation, in order to be able to use the <code class="language-plaintext highlighter-rouge">MyComponent</code>, we have to annotate it with JSR330.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nd">@Named</span>
<span class="nd">@Singleton</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyComponent</span>
    <span class="kd">implements</span> <span class="nc">Component</span>
<span class="o">{</span>
<span class="o">}</span>
</code></pre></div></div>

<div class="alert">
    <div style="margin-left: 0.7em;">
        <!--<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-exclamation-triangle-fill" viewBox="0 0 16 16">
            <path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/>
        </svg>--> 
        <strong>But</strong> I have discovered that it is also capable of injecting simple POJOs using their default constructor, even if the <code class="language-plaintext highlighter-rouge">@Named</code> or <code class="language-plaintext highlighter-rouge">@Singleton</code> annotations are not used.
    </div>
</div>

<p>The official <a href="https://maven.apache.org/maven-jsr330.html">documentation</a> gives a brief introduction to how maven uses it, and what to do to make the annotations work if you want to use them in your plugin or extension.<br />
The important thing to catch here, is the usage of the <a href="https://eclipse.org/sisu/docs/api/org.eclipse.sisu.mojos/">sisu-maven-plugin</a> in your project.  This will add your components to the index file so they are picked up by the SISU container.
From the docs:</p>
<blockquote>
Enumerating the implementations means that no classpath scanning is required in runtime to find them, which keeps Maven's startup time fast. Note that our container is configured by default to only use the index. While this keeps things fast, if you use JSR-330 components in dependencies that do not contain an index, those implementations will currently not be discovered. This is a compromise that is reasonable given Maven is a command-line tool where startup speed is important.
</blockquote>

<p>If you are interested in injecting components in the container dynamically, I unfortunately no other documentation other than <a href="https://github.com/eclipse/sisu.plexus/issues/35">this</a> long issue I have filled myself.
You can also take example of this <a href="https://github.com/HomeOfTheWizard/spring-bridge-maven-plugin">plugin</a> I have developped to achieve the same.</p>

<h2 id="4-maven-plugins">4. Maven Plugins</h2>
<p>When we execute a goal in maven, this points to a plugin’s code. Plugins consists of one or more <strong>Mojos</strong>, each one being the implementation for one of the plugin’s goals.
A Mojo is basically the API to use when coding your plugin, so that maven can use it.
I will not go into too much details here since there are already hundreds of articles/posts online, 
including the <a href="https://maven.apache.org/ref/3.9.6/maven-plugin-api/index.html">official documentation</a>, describing how to create a Mojo, build and package your plugin.</p>

<h2 id="5-maven-extensions">5. Maven Extensions</h2>
<p>Extensions are basically a way to add new features to maven core or to your project build lifecycle, by adding new classes to the different class loaders explained above. 
This allows us to insert code that will impact multiple plugins at once.</p>

<p>There are two types of extensions:</p>
<ol>
  <li><strong>Core extensions</strong> are loaded as part of Maven runtime startup and disposed of as part of Maven runtime shutdown.</li>
  <li><strong>Build extensions</strong> are loaded lazily during the build of your project.</li>
</ol>

<p>Difference between late and early registration refers to which class-world will it be part of. Early registration simply means that the extension will be used when maven core bootstraps. Late registration means that the extension will be used only after maven core is launched, our project model is built and our the built lifecycle has begun.</p>

<h3 id="51-core-extensions">5.1. Core Extensions</h3>
<p>Core Extensions is a new mechanism introduced in Maven 3.3.0 which allows additional components to be loaded into Maven Core as part of a build session.
As already seen above, each core extension is loaded in a separate classloader and there is no mechanism to share classes among core extensions. Core extensions classloaders use Maven Core classloader as the parent and have access to both exported and internal Maven Core classes.</p>

<p>From the <a href="https://maven.apache.org/guides/mini/guide-using-extensions.html">official documentation</a>:</p>
<blockquote>
The mechanism allows extensions to either replace default Sisu components with custom ones or add new components which are used at run time. In addition one could also expose additional packages from the Core Classloader.
</blockquote>

<p>What I want to highlight here is the mention: <em>“one could also expose additional packages from the Core Classloader”.</em><br />
Core extension can use <a href="https://maven.apache.org/ref/3.9.0/maven-core/core-extensions.html">META-INF/maven/extension.xml</a> descriptor (which declares what packages are exported from maven core to extensions) 
to declare packages and artifacts exported by the extension. If the descriptor is not present, no packages or artifacts are exported, but the extension can still contribute components to Maven Core extension points.</p>

<p>Core extensions are configured in <code class="language-plaintext highlighter-rouge">${maven.projectBasedir}/.mvn/extensions.xml</code> configuration file.</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;extensions&gt;</span>
  <span class="nt">&lt;extension&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>...<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>...<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>...<span class="nt">&lt;/version&gt;</span>
  <span class="nt">&lt;/extension&gt;</span>
  <span class="nt">&lt;extension&gt;</span>...<span class="nt">&lt;/extension&gt;</span>
  ...
<span class="nt">&lt;/extensions&gt;</span>
</code></pre></div></div>

<h3 id="52-build-extensions">5.2. Build Extensions</h3>
<p>From the <a href="https://maven.apache.org/pom.html#Extensions">docs</a>:</p>
<blockquote>
Extensions are a list of artifacts that are to be used in this build. They will be included in the running build's classpath. 
They can enable extensions to the build process (such as add an ftp provider for the Wagon transport mechanism), as well as make plugins active which make changes to the build lifecycle. 
In short, extensions are artifacts that activated during build. The extensions do not have to actually do anything nor contain a Mojo. 
For this reason, extensions are excellent for specifying one out of multiple implementations of a common plugin interface.
</blockquote>

<p>Those extensions are typically used to enable Wagon providers, used for the transport of artifact between repositories, and plug-ins which provide lifecycle enhancements.  <br />
Example:</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;build&gt;</span>
    <span class="nt">&lt;extensions&gt;</span>
      <span class="nt">&lt;extension&gt;</span>
        <span class="nt">&lt;groupId&gt;</span>org.apache.maven.wagon<span class="nt">&lt;/groupId&gt;</span>
         <span class="nt">&lt;artifactId&gt;</span>wagon-ftp<span class="nt">&lt;/artifactId&gt;</span>
         <span class="nt">&lt;version&gt;</span>2.10<span class="nt">&lt;/version&gt;</span>
      <span class="nt">&lt;/extension&gt;</span>
    <span class="nt">&lt;/extensions&gt;</span>
  <span class="nt">&lt;/build&gt;</span>
</code></pre></div></div>
<p>Build extensions are registered (late registration) via your <code class="language-plaintext highlighter-rouge">pom.xml</code>. Examples can be found <a href="https://maven.apache.org/guides/mini/guide-using-extensions.html#build-extension">here</a></p>

<hr />

<h1 id="recap">RECAP</h1>
<p>In this post I have tried to cover all the core components and internal mechanisms in maven that I found important to understand for a developer who wants to contribute to maven with a plugin or extension.</p>

<p>The distinction and interaction between the <strong>Core and the Plugin API</strong> is an important point to understand when we want to pinpoint which component we need to target for a new feature or fix.<br />
The <strong>Classloader system</strong> is what builds the boundaries between the core and plugins. Its understanding is crucial in order to prevent hours wasted trying to build our new project.<br />
Finally, the <strong>SISU</strong> container, which is at the core of maven, is and important component to understand if we want to build reusable components and build transverse features.</p>

<p>Hope that helps you in your journey. Next post will probably be on the maven core. Stay tuned ! 🖖</p>

<hr />

<h1>Appendix: References</h1>

<p>https://maven.apache.org/what-is-maven.html<br />
https://maven.apache.org/plugins/index.html<br />
https://maven.apache.org/plugin-developers/index.html<br />
https://maven.apache.org/plugin-developers/common-bugs.html<br />
https://en.wikipedia.org/wiki/Java_Classloader<br />
https://maven.apache.org/guides/mini/guide-maven-classloading.html#Core_Classloader<br />
http://takari.io/book/91-maven-classloading.html<br />
https://cwiki.apache.org/confluence/display/MAVEN/Maven+3.x+Class+Loading<br />
https://eclipse.github.io/sisu.plexus/<br />
https://developer.okta.com/blog/2019/09/23/tutorial-build-a-maven-plugin<br />
https://maven.apache.org/guides/mini/guide-using-extensions.html</p>]]></content><author><name>Özgün ÖZ</name></author><category term="development" /><category term="java" /><summary type="html"><![CDATA[Deep dive into maven’s internals to help the development of plugins]]></summary></entry></feed>